<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RepoRover - Analyze GitHub Repositories</title>
    <link href="https://www.svgrepo.com/show/530491/search-alt.svg" rel="icon" type="image/svg+xml">
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Spline+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <style type="text/tailwindcss">
        :root {
            --primary-color: #ea2a33;
        }
        body {
            font-family: "Spline Sans", sans-serif;
        }
        .hidden { display: none !important; }
        .fade-in { 
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">

    <div id="welcome-page" class="page">
        <div class="flex flex-col items-center justify-center min-h-screen p-4 text-center">
            <header class="mb-10">
                <div class="flex items-center justify-center gap-3">
                  <img src="static/logo.svg" alt="RepoRover Logo" class="w-12 h-12">
                  <h1 class="text-5xl font-bold tracking-tight text-gray-900">RepoRover</h1>
                </div>
            </header>

            <main class="w-full max-w-2xl">
                <h2 class="text-2xl md:text-3xl font-semibold text-gray-800 mb-4">Unlock the secrets of your code.</h2>
                <p class="text-lg text-gray-600 mb-8">Paste a GitHub repository URL to get a deep analysis of code quality, dependencies, and potential vulnerabilities.</p>

                <form id="repo-form" class="flex flex-col sm:flex-row items-center gap-4 w-full">
                    <label class="sr-only" for="repo-url">GitHub Repository URL</label>
                    <input class="form-input flex-grow w-full px-4 py-3 text-base text-gray-700 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent transition-shadow" 
                           id="repo-url" 
                           name="repo-url" 
                           placeholder="https://github.com/user/repository" 
                           required 
                           type="url">
                    <button class="flex items-center justify-center w-full sm:w-auto px-6 py-3 bg-[var(--primary-color)] text-white text-base font-semibold rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" 
                            type="submit" 
                            id="analyze-btn">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M13.5 4.5 21 12m0 0-7.5 7.5M21 12H3" stroke-linecap="round" stroke-linejoin="round"></path>
                        </svg>
                        Analyze
                    </button>
                </form>

                <p class="text-sm text-gray-500 mt-4">Enter a public repository URL to begin.</p>
            </main>
        </div>
    </div>

    <div id="processing-page" class="page hidden">
        <div class="relative flex size-full min-h-screen flex-col group/design-root overflow-x-hidden">
            <div class="layout-container flex h-full grow flex-col">
                <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-gray-200 px-10 py-3">
                  <div class="flex items-center gap-4 text-gray-900">
                    <img src="static/logo.svg" alt="RepoRover Logo" class="w-8 h-8">
                    <h2 class="text-gray-900 text-lg font-bold leading-tight tracking-[-0.015em]">RepoRover</h2>
                  </div>
                  <div class="flex flex-1 justify-end gap-4">
                    <nav class="flex items-center gap-6">
                        <a class="text-gray-900 text-sm font-medium leading-normal hover:text-[var(--primary-color)] transition-colors" href="#">Home</a>
                        <a class="text-gray-900 text-sm font-medium leading-normal hover:text-[var(--primary-color)] transition-colors" href="#">Explore</a>
                        <a class="text-gray-900 text-sm font-medium leading-normal hover:text-[var(--primary-color)] transition-colors" href="#">Pricing</a>
                    </nav>
                    <div class="flex items-center gap-4">
                      <button class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-6 bg-[var(--primary-color)] text-white text-sm font-bold leading-normal tracking-[0.015em] hover:bg-red-700 transition-colors" onclick="goToWelcome()">
                          <span class="truncate">New Analysis</span>
                      </button>
                      <div class="relative">
                        <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuADOie7PO-YL3ctotTK4WQarcxUKOEnkQ_wvbcbBCJK5LOwJR3HLPm8NTEWYoLaMM-dcq0hiiLyPDC1uRAGO3AgHwdpIIsgMKq1MEeHScE74FSr-p8ikREi7o_cxynRGONx9eZKwJ0O2-VzHvL6ey0lRg3A1V7m006BjpIahNPtuLF-cSfUI1VjTGzVOdQ_vsRju56NQ0x-pxDN_AxN6qWKI4idbB12UVGul9El-lvNQMZCSqtfsSZVixiWtF5rMIOR6SVETj28yFo");'></div>
                      </div>
                  </div>
                </header>

                <main class="flex flex-1 justify-center py-16 px-4">
                    <div class="w-full max-w-2xl text-center">
                        <div class="mb-8 flex justify-center">
                            <svg class="spin h-12 w-12 text-[var(--primary-color)]" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" fill="currentColor"></path>
                            </svg>
                        </div>

                        <h1 class="text-3xl font-bold tracking-tight text-gray-900 sm:text-4xl">Analyzing Repository...</h1>
                        <p class="mt-4 text-lg text-gray-600">Please wait while we process your request. This may take a few moments.</p>
                        <p class="mt-2 text-sm text-gray-500">Repository: <span id="current-repo" class="font-mono"></span></p>

                        <div class="mt-12 bg-white rounded-lg shadow-lg p-6 text-left">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <svg class="w-5 h-5 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M4 6h16M4 12h16M4 18h7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
                                </svg>
                                Ingestion Log
                            </h3>

                            <div id="log-container" class="space-y-4 font-mono text-sm text-gray-600 max-h-64 overflow-y-auto">
                                </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <div id="chat-page" class="page hidden">
        <div class="flex flex-col h-screen">
            <header class="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-white">
              <div class="flex items-center gap-3">
                <img src="static/logo.svg" alt="RepoRover Logo" class="w-8 h-8">
                <h1 class="text-xl font-bold text-gray-900">
                  <span class="font-normal text-gray-500">Repository:</span> <span id="chat-repo-name"></span>
                </h1>
              </div>
              <div class="flex items-center gap-4">
                <div class="relative">
                  <button class="flex items-center justify-center size-10 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors" onclick="goToWelcome()">
                    <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0- 0 24 24" xmlns="http://www.w3.org/2000/svg">
                      <path d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
                    </svg>
                  </button>
                </div>
                <div class="size-10 rounded-full bg-cover bg-center" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuAaK4Zqb5XehE3R3EPa-WFkg5fbj7axcVSKRwZ1HT1-n7JOBrZLKCui65WVatdeunU2KOTpwExrc5CCHs4nurH1-eEu2_pjhhUObtCxsyBCywdCMBQdBO8rBBBl9RoxcwyACeooQoJj-fr98Dq3KonruMuQ4AeSO0mzC3qh-JrdCeFKqbIj1khslMD_1DWIbdmw6uRyAum4rp3Yrq5US9BdII0RSBMO4MphhOk3cuds6ld_DWWSY_bQKZ4b2GxM8O1wPlMLo7g9b3c");'></div>
              </div>
            </header>

            <main id="chat-messages" class="flex-1 overflow-y-auto p-6 space-y-8">
                <div class="flex items-start gap-4">
                    <div class="flex-shrink-0 size-10 rounded-full bg-[var(--primary-color)] flex items-center justify-center text-white font-bold text-xl">
                        R
                    </div>
                    <div class="bg-white p-4 rounded-lg rounded-tl-none shadow-sm max-w-lg">
                        <p class="font-bold text-gray-900 mb-1">RepoRover</p>
                        <p class="text-gray-700" id="welcome-message">
                            Hello! I'm RepoRover, your AI assistant for understanding code repositories. How can I help you analyze the repository today?
                        </p>
                    </div>
                </div>
            </main>

            <footer class="bg-white border-t border-gray-200 p-4">
                <div class="max-w-4xl mx-auto">
                    <form id="chat-form" class="relative">
                        <textarea id="chat-input" 
                                  class="w-full h-12 p-3 pr-28 border border-gray-300 rounded-full resize-none focus:ring-2 focus:ring-[var(--primary-color)] focus:border-transparent transition-shadow" 
                                  placeholder="Ask a follow-up question about the repository..." 
                                  rows="1"></textarea>
                        <div class="absolute inset-y-0 right-3 flex items-center gap-2">
                            <button type="button" class="p-2 text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="currentColor" height="24" viewBox="0 0 256 256" width="24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M209.66,122.34a8,8,0,0,1,0,11.32l-82.05,82a56,56,0,0,1-79.2-79.21L147.67,35.73a40,40,0,1,1,56.61,56.55L105,193A24,24,0,1,1,71,159L154.3,74.38A8,8,0,1,1,165.7,85.6L82.39,170.31a8,8,0,1,0,11.27,11.36L192.93,81A24,24,0,1,0,159,47L59.76,147.68a40,40,0,1,0,56.53,56.62l82.06-82A8,8,0,0,1,209.66,122.34Z"></path>
                                </svg>
                            </button>
                            <button type="submit" 
                                    id="send-btn"
                                    class="flex items-center justify-center h-10 w-10 rounded-full bg-[var(--primary-color)] text-white hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M5 12h14M12 5l7 7-7 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
                                </svg>
                            </button>
                        </div>
                    </form>
                </div>
            </footer>
        </div>
    </div>

    <script>
        // Global state
        let currentRepo = '';
        let pollInterval = null;

        // Page management
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.add('hidden');
            });
            document.getElementById(pageId).classList.remove('hidden');
            document.getElementById(pageId).classList.add('fade-in');
        }

        function goToWelcome() {
            showPage('welcome-page');
            document.getElementById('repo-form').reset();
            currentRepo = '';
            if (pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            }
        }

        // Repository form submission
        document.getElementById('repo-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const repoUrl = document.getElementById('repo-url').value.trim();
            if (!repoUrl) return;

            const repoName = repoUrl.split('/').slice(-2).join('/');
            currentRepo = repoName;
            
            document.getElementById('current-repo').textContent = repoUrl;
            document.getElementById('log-container').innerHTML = '';
            
            showPage('processing-page');
            
            try {
                const response = await fetch('/ingest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ github_url: repoUrl }),
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to start ingestion');
                }

                const data = await response.json();
                const taskId = data.task_id;

                if (taskId) {
                    startPolling(taskId);
                } else {
                    throw new Error("Did not receive a task ID from the server.");
                }
                
            } catch (error) {
                updateLog(error.message, 'error');
                setTimeout(goToWelcome, 3000);
            }
        });

        // Polling for ingestion status
        function startPolling(taskId) {
            if (pollInterval) clearInterval(pollInterval);

            addLogEntry('Request received, starting ingestion...', 'progress');

            pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/ingest/status/${taskId}`);
                    if (!response.ok) {
                        throw new Error(`Server returned status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    updateLog(data.message, data.status);

                    if (data.status === 'completed') {
                        clearInterval(pollInterval);
                        pollInterval = null;
                        setTimeout(showChatPage, 1500);
                    } else if (data.status === 'error') {
                        clearInterval(pollInterval);
                        pollInterval = null;
                        setTimeout(goToWelcome, 3000);
                    }
                } catch (error) {
                    updateLog('Failed to get status: ' + error.message, 'error');
                    clearInterval(pollInterval);
                    pollInterval = null;
                    setTimeout(goToWelcome, 3000);
                }
            }, 2500);
        }

        let lastLogMessage = '';
        function updateLog(message, status) {
            if (message === lastLogMessage) return;
            lastLogMessage = message;
            addLogEntry(message, status);
        }

        function addLogEntry(message, status) {
            const logContainer = document.getElementById('log-container');
            const logEntry = document.createElement('div');
            logEntry.className = 'flex items-center';
            
            let icon, statusText, statusClass;
            
            switch (status) {
                case 'completed':
                case 'success':
                    icon = '<div class="w-2.5 h-2.5 bg-green-500 rounded-full"></div>';
                    statusText = 'Done';
                    statusClass = 'text-green-500';
                    break;
                case 'ingesting':
                case 'progress':
                    icon = '<svg class="spin h-4 w-4 text-[var(--primary-color)]" fill="none" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" fill="currentColor"></path></svg>';
                    statusText = 'In Progress';
                    statusClass = 'text-[var(--primary-color)]';
                    break;
                case 'error':
                    icon = '<div class="w-2.5 h-2.5 bg-red-500 rounded-full"></div>';
                    statusText = 'Error';
                    statusClass = 'text-red-500';
                    break;
                default:
                    icon = '<div class="w-2.5 h-2.5 bg-gray-400 rounded-full"></div>';
                    statusText = 'Pending';
                    statusClass = 'text-gray-500';
            }
            
            logEntry.innerHTML = `
                <div class="w-6 h-6 flex items-center justify-center mr-3">
                    ${icon}
                </div>
                <span>${message}</span>
                <span class="ml-auto ${statusClass} font-semibold">${statusText}</span>
            `;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function showChatPage() {
            document.getElementById('chat-repo-name').textContent = currentRepo;
            document.getElementById('welcome-message').textContent = 
                `Hello! I'm RepoRover. I've finished analyzing the ${currentRepo} repository. How can I help you?`;
            showPage('chat-page');
        }

        // Chat functionality
        document.getElementById('chat-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const input = document.getElementById('chat-input');
            const question = input.value.trim();
            if (!question) return;
            
            addMessage(question, 'user');
            input.value = '';
            
            const typingId = addMessage('', 'agent', true);
            
            try {
                const response = await fetch('/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: question }),
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to get response');
                }
                
                const result = await response.json();
                const answer = result.result?.final_response?.response || result.message || 'Sorry, I could not find an answer.';
                
                document.getElementById(typingId).remove();
                addMessage(answer, 'agent');
                
            } catch (error) {
                document.getElementById(typingId).remove();
                addMessage('Sorry, I encountered an error: ' + error.message, 'agent');
            }
        });

        function addMessage(text, role, isTyping = false) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            const messageId = 'msg-' + Date.now();
            messageDiv.id = messageId;
            messageDiv.className = `flex items-start gap-4 ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            
            if (role === 'user') {
                messageDiv.innerHTML = `
                    <div class="bg-blue-500 text-white p-4 rounded-lg rounded-br-none shadow-sm max-w-lg">
                        <p>${text}</p>
                    </div>
                    <div class="flex-shrink-0 size-10 rounded-full bg-cover bg-center" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuAaK4Zqb5XehE3R3EPa-WFkg5fbj7axcVSKRwZ1HT1-n7JOBrZLKCui65WVatdeunU2KOTpwExrc5CCHs4nurH1-eEu2_pjhhUObtCxsyBCywdCMBQdBO8rBBBl9RoxcwyACeooQoJj-fr98Dq3KonruMuQ4AeSO0mzC3qh-JrdCeFKqbIj1khslMD_1DWIbdmw6uRyAum4rp3Yrq5US9BdII0RSBMO4MphhOk3cuds6ld_DWWSY_bQKZ4b2GxM8O1wPlMLo7g9b3c");'></div>
                `;
            } else {
                const content = isTyping ? 
                    '<div class="flex items-center space-x-1"><div class="w-2 h-2 bg-gray-500 rounded-full animate-pulse"></div><div class="w-2 h-2 bg-gray-500 rounded-full animate-pulse" style="animation-delay: 0.2s"></div><div class="w-2 h-2 bg-gray-500 rounded-full animate-pulse" style="animation-delay: 0.4s"></div></div>' :
                    `<p class="font-bold text-gray-900 mb-1">RepoRover</p><p class="text-gray-700">${text}</p>`;
                
                messageDiv.innerHTML = `
                    <div class="flex-shrink-0 size-10 rounded-full bg-[var(--primary-color)] flex items-center justify-center text-white font-bold text-xl">
                        R
                    </div>
                    <div class="bg-white p-4 rounded-lg rounded-tl-none shadow-sm max-w-lg">
                        ${content}
                    </div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            return messageId;
        }

        // Auto-resize textarea
        document.getElementById('chat-input').addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Initialize
        showPage('welcome-page');
    </script>
</body>
</html>